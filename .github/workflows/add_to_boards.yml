name: Add labeled issue to Project Boards

on:
  issues:
    types: [labeled, unlabeled]

jobs:
  add-to-dse-project:
    if: github.event.label.name == 'dse' && github.event.action == 'labeled'
    runs-on: ubuntu-latest
    steps:
      - name: Add issue to DSE GitHub Project
        uses: actions/add-to-project@v1.0.2
        with:
          project-url: https://github.com/orgs/NASA-IMPACT/projects/145
          github-token: ${{ secrets.DSE_GH_TOKEN }}

  add-to-odd-project:
    if: github.event.label.name == 'odd' && github.event.action == 'labeled'
    runs-on: ubuntu-latest
    steps:
      - name: Add issue to ODD GitHub Project
        uses: actions/add-to-project@v1.0.2
        with:
          project-url: https://github.com/orgs/NASA-IMPACT/projects/136
          github-token: ${{ secrets.DSE_GH_TOKEN }}

  add-to-dashboard-project:
    if: github.event.label.name == 'dashboard' && github.event.action == 'labeled'
    runs-on: ubuntu-latest
    steps:
      - name: Add issue to Dashboard GitHub Project
        uses: actions/add-to-project@v1.0.2
        with:
          project-url: https://github.com/orgs/NASA-IMPACT/projects/17
          github-token: ${{ secrets.DSE_GH_TOKEN }}

  add-to-data-services-project:
    if: github.event.label.name == 'dataServices' && github.event.action == 'labeled'
    runs-on: ubuntu-latest
    steps:
      - name: Add issue to Data Services GitHub Project
        uses: actions/add-to-project@v1.0.2
        with:
          project-url: https://github.com/orgs/NASA-IMPACT/projects/51
          github-token: ${{ secrets.DSE_GH_TOKEN }}

  remove-from-dse-project:
    if: github.event.label.name == 'dse' && github.event.action == 'unlabeled'
    runs-on: ubuntu-latest
    steps:
      - name: Remove issue from DSE GitHub Project
        env:
          GITHUB_TOKEN: ${{ secrets.DSE_GH_TOKEN }}
          ISSUE_ID: ${{ github.event.issue.node_id }}
        run: |
          gh api graphql -f query='
            query($org: String!, $number: Int!) {
              organization(login: $org) {
                projectV2(number: $number) {
                  id
                  items(first: 100) {
                    nodes {
                      id
                      content {
                        ... on Issue {
                          id
                        }
                      }
                    }
                  }
                }
              }
            }' -f org='NASA-IMPACT' -F number=145 > project_data.json

          ITEM_ID=$(jq -r --arg issue_id "$ISSUE_ID" '.data.organization.projectV2.items.nodes[] | select(.content.id == $issue_id) | .id' project_data.json)
          PROJECT_ID=$(jq -r '.data.organization.projectV2.id' project_data.json)

          if [ -n "$ITEM_ID" ] && [ "$ITEM_ID" != "null" ]; then
            gh api graphql -f query='
              mutation($projectId: ID!, $itemId: ID!) {
                deleteProjectV2Item(input: {projectId: $projectId, itemId: $itemId}) {
                  deletedItemId
                }
              }' -f projectId="$PROJECT_ID" -f itemId="$ITEM_ID"
            echo "Removed issue from project"
          else
            echo "Issue not found in project"
          fi

  remove-from-odd-project:
    if: github.event.label.name == 'odd' && github.event.action == 'unlabeled'
    runs-on: ubuntu-latest
    steps:
      - name: Remove issue from ODD GitHub Project
        env:
          GITHUB_TOKEN: ${{ secrets.DSE_GH_TOKEN }}
          ISSUE_ID: ${{ github.event.issue.node_id }}
        run: |
          gh api graphql -f query='
            query($org: String!, $number: Int!) {
              organization(login: $org) {
                projectV2(number: $number) {
                  id
                  items(first: 100) {
                    nodes {
                      id
                      content {
                        ... on Issue {
                          id
                        }
                      }
                    }
                  }
                }
              }
            }' -f org='NASA-IMPACT' -F number=136 > project_data.json

          ITEM_ID=$(jq -r --arg issue_id "$ISSUE_ID" '.data.organization.projectV2.items.nodes[] | select(.content.id == $issue_id) | .id' project_data.json)
          PROJECT_ID=$(jq -r '.data.organization.projectV2.id' project_data.json)

          if [ -n "$ITEM_ID" ] && [ "$ITEM_ID" != "null" ]; then
            gh api graphql -f query='
              mutation($projectId: ID!, $itemId: ID!) {
                deleteProjectV2Item(input: {projectId: $projectId, itemId: $itemId}) {
                  deletedItemId
                }
              }' -f projectId="$PROJECT_ID" -f itemId="$ITEM_ID"
            echo "Removed issue from project"
          else
            echo "Issue not found in project"
          fi

  remove-from-dashboard-project:
    if: github.event.label.name == 'dashboard' && github.event.action == 'unlabeled'
    runs-on: ubuntu-latest
    steps:
      - name: Remove issue from Dashboard GitHub Project
        env:
          GITHUB_TOKEN: ${{ secrets.DSE_GH_TOKEN }}
          ISSUE_ID: ${{ github.event.issue.node_id }}
        run: |
          gh api graphql -f query='
            query($org: String!, $number: Int!) {
              organization(login: $org) {
                projectV2(number: $number) {
                  id
                  items(first: 100) {
                    nodes {
                      id
                      content {
                        ... on Issue {
                          id
                        }
                      }
                    }
                  }
                }
              }
            }' -f org='NASA-IMPACT' -F number=17 > project_data.json

          ITEM_ID=$(jq -r --arg issue_id "$ISSUE_ID" '.data.organization.projectV2.items.nodes[] | select(.content.id == $issue_id) | .id' project_data.json)
          PROJECT_ID=$(jq -r '.data.organization.projectV2.id' project_data.json)

          if [ -n "$ITEM_ID" ] && [ "$ITEM_ID" != "null" ]; then
            gh api graphql -f query='
              mutation($projectId: ID!, $itemId: ID!) {
                deleteProjectV2Item(input: {projectId: $projectId, itemId: $itemId}) {
                  deletedItemId
                }
              }' -f projectId="$PROJECT_ID" -f itemId="$ITEM_ID"
            echo "Removed issue from project"
          else
            echo "Issue not found in project"
          fi

  remove-from-data-services-project:
    if: github.event.label.name == 'dataServices' && github.event.action == 'unlabeled'
    runs-on: ubuntu-latest
    steps:
      - name: Remove issue from Data Services GitHub Project
        env:
          GITHUB_TOKEN: ${{ secrets.DSE_GH_TOKEN }}
          ISSUE_ID: ${{ github.event.issue.node_id }}
        run: |
          gh api graphql -f query='
            query($org: String!, $number: Int!) {
              organization(login: $org) {
                projectV2(number: $number) {
                  id
                  items(first: 100) {
                    nodes {
                      id
                      content {
                        ... on Issue {
                          id
                        }
                      }
                    }
                  }
                }
              }
            }' -f org='NASA-IMPACT' -F number=51 > project_data.json

          ITEM_ID=$(jq -r --arg issue_id "$ISSUE_ID" '.data.organization.projectV2.items.nodes[] | select(.content.id == $issue_id) | .id' project_data.json)
          PROJECT_ID=$(jq -r '.data.organization.projectV2.id' project_data.json)

          if [ -n "$ITEM_ID" ] && [ "$ITEM_ID" != "null" ]; then
            gh api graphql -f query='
              mutation($projectId: ID!, $itemId: ID!) {
                deleteProjectV2Item(input: {projectId: $projectId, itemId: $itemId}) {
                  deletedItemId
                }
              }' -f projectId="$PROJECT_ID" -f itemId="$ITEM_ID"
            echo "Removed issue from project"
          else
            echo "Issue not found in project"
          fi
